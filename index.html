<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ ¡åœ’ GPS é—–é—œéŠæˆ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 4px;
      text-align: center;
    }
    h2 {
      font-size: 1.1rem;
      margin-top: 20px;
      margin-bottom: 8px;
    }
    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      max-width: 800px;
      margin: 0 auto 20px;
    }
    .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 8px 0 12px;
    }
    button {
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      white-space: nowrap;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    button:active {
      transform: scale(0.97);
    }
    #status {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 4px;
    }
    #currentPos {
      font-size: 0.9rem;
      color: #333;
      line-height: 1.5;
    }
    #log {
      margin-top: 8px;
      font-size: 0.9rem;
      max-height: 120px;
      overflow-y: auto;
      background: #fafafa;
      border-radius: 8px;
      padding: 8px;
      border: 1px solid #eee;
    }
    .log-item {
      margin-bottom: 4px;
    }
    #checkpointList {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 8px;
    }
    .cp-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid #e3e3e3;
    }
    .cp-card.done {
      border-color: #22c55e;
      background: #ecfdf3;
    }
    .cp-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    .cp-name {
      font-weight: 600;
      font-size: 1rem;
    }
    .cp-tag {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e5e7eb;
    }
    .cp-tag.done {
      background: #4ade80;
      color: #064e3b;
    }
    .cp-body {
      font-size: 0.85rem;
      line-height: 1.4;
    }
    .cp-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 8px;
      margin-top: 4px;
    }
    .cp-distance,
    .cp-radius {
      font-size: 0.85rem;
    }
    .cp-links a {
      font-size: 0.85rem;
      text-decoration: none;
    }
    .cp-links a:hover {
      text-decoration: underline;
    }
    #progressArea {
      margin-top: 10px;
      font-size: 0.9rem;
    }
    progress {
      width: 100%;
      height: 12px;
      margin-top: 4px;
    }
    .hint {
      font-size: 0.8rem;
      color: #666;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>æ ¡åœ’ GPS é—–é—œéŠæˆ²</h1>
    <p style="font-size:0.9rem; text-align:center;">
      èµ°åˆ°æŒ‡å®šåœ°é»æ‰èƒ½å®Œæˆé—œå¡ï¼è«‹é–‹å•Ÿæ‰‹æ©Ÿå®šä½ï¼Œæ²¿è‘—æ ¡åœ’å°‹å¯¶ï½
    </p>

    <div class="btn-row">
      <button id="startBtn">â–¶ é–‹å§‹ GPS è¿½è¹¤</button>
      <button id="stopBtn" disabled>â¹ åœæ­¢è¿½è¹¤</button>
    </div>

    <div id="status">å°šæœªé–‹å§‹å®šä½ã€‚</div>
    <div id="currentPos">ç›®å‰ä½ç½®ï¼šæœªçŸ¥</div>

    <div id="progressArea">
      <div id="progressText">å®Œæˆåº¦ï¼š0 / 3 é—œå¡</div>
      <progress id="progressBar" max="100" value="0"></progress>
    </div>

    <h2>é—–é—œæ¸…å–®</h2>
    <div id="checkpointList"></div>

    <h2>è¨Šæ¯ / ç³»çµ±æç¤º</h2>
    <div id="log"></div>

    <hr>
    <p class="hint">
      âš  æ•™å¸«ä½¿ç”¨èªªæ˜ï¼š<br>
      1. è«‹å°‡ç¨‹å¼ç¢¼ä¸­ <code>checkpoints</code> é™£åˆ—è£¡çš„ <b>ç·¯åº¦ (lat)</b>ã€<b>ç¶“åº¦ (lng)</b> æ”¹æˆè‡ªå·±æ ¡åœ’å„åœ°é»ã€‚<br>
      2. åœ¨ Google åœ°åœ–ä¸Šå°å»ºç¯‰ç‰©æŒ‰å³éµ â†’ã€Œé€™è£¡æœ‰ä»€éº¼ï¼Ÿã€å¯ä»¥çœ‹åˆ°åº§æ¨™ã€‚<br>
      3. å»ºè­°è®“å­¸ç”Ÿä½¿ç”¨ <b>HTTPS ç¶²ç«™</b> æˆ– <b>æ­é…æœ¬æ©Ÿä¼ºæœå™¨ (localhost)</b> é–‹å•Ÿæ­¤ç¶²é ï¼Œæ‰‹æ©Ÿéœ€å…è¨±å®šä½æ¬Šé™ã€‚
    </p>
  </div>

  <script>
    // === 1. åœ¨é€™è£¡è¨­å®šæ ¡åœ’é—œå¡ ===
    // è«‹æŠŠä¸‹é¢çš„ç¯„ä¾‹åº§æ¨™æ”¹æˆä½ å€‘å­¸æ ¡å„å¤§æ¨“æˆ–é—œå¡çš„ä½ç½®
    // radius: å®¹è¨±çš„è·é›¢ï¼ˆå…¬å°ºï¼‰ï¼Œå­¸ç”Ÿé€²å…¥é€™å€‹ç¯„åœå°±ç®—å®Œæˆ
    const checkpoints = [
      {
        id: 1,
        name: "é—œå¡1ï¼šæ ¡é–€å£",
        lat: 24.58986,   // â† æ”¹æˆæ ¡é–€å£çš„ç·¯åº¦
        lng: 120.83098,  // â† æ”¹æˆæ ¡é–€å£çš„ç¶“åº¦
        radius: 40,       // å®¹è¨±ç¯„åœï¼Œ40 å…¬å°ºä»¥å…§ç®—åˆ°é”
        task: "åœ¨æ ¡é–€å£æ‹ä¸€å¼µåˆç…§ï¼Œä¸¦èªªå‡ºä»Šå¤©çš„é—–é—œå£è™Ÿã€‚",
        completed: false
      },
      {
        id: 2,
        name: "é—œå¡2ï¼šæ“å ´çœ‹å°",
        lat: 24.58963,     // â† æ”¹æˆæ“å ´é™„è¿‘çš„ç·¯åº¦
        lng: 120.83129,    // â† æ”¹æˆæ“å ´é™„è¿‘çš„ç¶“åº¦
        radius: 40,
        task: "æ‰¾åˆ°æ“å ´çœ‹å°ï¼Œæ¨¡ä»¿é‹å‹•å“¡ä¼¸å±•å‹•ä½œ 5 ç§’é˜ã€‚",
        completed: false
      },
      {
        id: 3,
        name: "é—œå¡3ï¼šåœ–æ›¸é¤¨",
        lat: 24.58954,     // â† æ”¹æˆåœ–æ›¸é¤¨çš„ç·¯åº¦
        lng: 120.83018,    // â† æ”¹æˆåœ–æ›¸é¤¨çš„ç¶“åº¦
        radius: 40,
        task: "åˆ°åœ–æ›¸é¤¨é–€å£ï¼Œèªªå‡ºä¸€æœ¬ä½ æƒ³çœ‹çš„æ›¸çš„åå­—ã€‚",
        completed: false
      }
    ];

    // === 2. DOM å…ƒç´  ===
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusEl = document.getElementById("status");
    const currentPosEl = document.getElementById("currentPos");
    const checkpointListEl = document.getElementById("checkpointList");
    const logEl = document.getElementById("log");
    const progressTextEl = document.getElementById("progressText");
    const progressBarEl = document.getElementById("progressBar");

    let watchId = null; // geolocation ç›£è½ IDï¼Œç”¨ä¾†åœæ­¢è¿½è¹¤

    // === 3. å·¥å…·ï¼šè¨ˆç®—å…©é»é–“è·é›¢ï¼ˆå…¬å°ºï¼‰ ===
    // ä½¿ç”¨ haversine formula
    function getDistanceInMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000; // åœ°çƒåŠå¾‘ï¼ˆå…¬å°ºï¼‰
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // === 4. æ¸²æŸ“é—–é—œæ¸…å–® ===
    function renderCheckpoints() {
      checkpointListEl.innerHTML = "";
      checkpoints.forEach(cp => {
        const card = document.createElement("div");
        card.className = "cp-card";
        card.id = "cp-" + cp.id;

        const header = document.createElement("div");
        header.className = "cp-header";

        const nameSpan = document.createElement("div");
        nameSpan.className = "cp-name";
        nameSpan.textContent = cp.name;

        const tagSpan = document.createElement("div");
        tagSpan.className = "cp-tag cp-status";
        tagSpan.textContent = "â³ å°šæœªå®Œæˆ";

        header.appendChild(nameSpan);
        header.appendChild(tagSpan);

        const body = document.createElement("div");
        body.className = "cp-body";
        body.innerHTML = `
          ä»»å‹™èªªæ˜ï¼š${cp.task}
          <div class="cp-row">
            <div class="cp-radius">å®Œæˆæ¢ä»¶ï¼šè·é›¢ç›®æ¨™ â‰¤ ${cp.radius} å…¬å°º</div>
            <div class="cp-distance" data-id="${cp.id}">ç›®å‰è·é›¢ï¼š-- å…¬å°º</div>
          </div>
          <div class="cp-links">
            <a href="https://www.google.com/maps?q=${cp.lat},${cp.lng}" target="_blank" rel="noopener">
              åœ¨ Google åœ°åœ–é–‹å•Ÿæ­¤é—œå¡
            </a>
          </div>
        `;

        card.appendChild(header);
        card.appendChild(body);
        checkpointListEl.appendChild(card);
      });
    }

    renderCheckpoints();

    // === 5. æ›´æ–°é—–é—œé€²åº¦ ===
    function updateProgress() {
      const total = checkpoints.length;
      const done = checkpoints.filter(cp => cp.completed).length;
      progressTextEl.textContent = `å®Œæˆåº¦ï¼š${done} / ${total} é—œå¡`;
      const percent = total === 0 ? 0 : (done / total) * 100;
      progressBarEl.value = percent;

      if (done === total && total > 0) {
        addLog("ğŸ‰ å…¨éƒ¨é—œå¡å®Œæˆï¼æ­å–œä½ å®Œæˆæ ¡åœ’ GPS å¤§å†’éšªï¼");
      }
    }

    // === 6. æ ¹æ“šç›®å‰ä½ç½®æ›´æ–°å„é—œå¡ç‹€æ…‹ ===
    function updateCheckpointsWithLocation(lat, lng) {
      checkpoints.forEach(cp => {
        const distance = getDistanceInMeters(lat, lng, cp.lat, cp.lng);
        const card = document.getElementById("cp-" + cp.id);
        const distEl = card.querySelector(".cp-distance");
        const statusTag = card.querySelector(".cp-status");

        if (distEl) {
          distEl.textContent = `ç›®å‰è·é›¢ï¼š${distance.toFixed(1)} å…¬å°º`;
        }

        if (distance <= cp.radius) {
          if (!cp.completed) {
            cp.completed = true;
            statusTag.textContent = "âœ… å·²å®Œæˆ";
            statusTag.classList.add("done");
            card.classList.add("done");
            addLog(`âœ… æ­å–œï¼ä½ å·²ç¶“æŠµé”ã€Œ${cp.name}ã€ä¸¦å®Œæˆä»»å‹™ï¼`);

            // æ‰‹æ©Ÿè¼•å¾®éœ‡å‹•æé†’ï¼ˆå¦‚æœæ”¯æ´ï¼‰
            if (navigator.vibrate) {
              navigator.vibrate(200);
            }
          }
        } else {
          if (!cp.completed) {
            statusTag.textContent = "â³ å°šæœªå®Œæˆ";
            statusTag.classList.remove("done");
            card.classList.remove("done");
          }
        }
      });

      updateProgress();
    }

    // === 7. Log å€åŸŸ ===
    function addLog(text) {
      const item = document.createElement("div");
      item.className = "log-item";
      const time = new Date().toLocaleTimeString();
      item.textContent = `[${time}] ${text}`;
      logEl.prepend(item);
    }

    // === 8. GPS æˆåŠŸå›å‚³ ===
    function handleSuccess(position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      const acc = position.coords.accuracy;

      statusEl.textContent = "å®šä½æˆåŠŸï¼ŒæŒçºŒè¿½è¹¤ä¸­â€¦";
      currentPosEl.innerHTML = `
        ç›®å‰ä½ç½®ï¼š<br>
        ç·¯åº¦ (lat)ï¼š${lat.toFixed(6)}<br>
        ç¶“åº¦ (lng)ï¼š${lng.toFixed(6)}<br>
        ç²¾åº¦ï¼šç´„ ${acc.toFixed(1)} å…¬å°º
      `;

      updateCheckpointsWithLocation(lat, lng);
    }

    // === 9. GPS å¤±æ•— / éŒ¯èª¤ ===
    function handleError(err) {
      console.warn(err);
      let msg = "ç„¡æ³•å–å¾—ä½ç½®ã€‚";
      switch (err.code) {
        case err.PERMISSION_DENIED:
          msg = "ä½¿ç”¨è€…æ‹’çµ•æä¾›å®šä½æ¬Šé™ï¼Œç„¡æ³•é€²è¡Œ GPS é—–é—œã€‚";
          break;
        case err.POSITION_UNAVAILABLE:
          msg = "ç„¡æ³•å–å¾—ä½ç½®è³‡è¨Šï¼Œå¯èƒ½æ˜¯æ²’æœ‰ GPS æˆ–ç¶²è·¯è¨Šè™Ÿã€‚";
          break;
        case err.TIMEOUT:
          msg = "å–å¾—ä½ç½®é€¾æ™‚ï¼Œè«‹ç§»å‹•åˆ°ç©ºæ› è™•å†è©¦ä¸€æ¬¡ã€‚";
          break;
        default:
          msg = "ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼ŒéŒ¯èª¤ç¢¼ï¼š" + err.code;
      }
      statusEl.textContent = msg;
      addLog("âš  " + msg);
    }

    // === 10. æŒ‰éˆ•äº‹ä»¶ ===
    startBtn.addEventListener("click", () => {
      if (!navigator.geolocation) {
        statusEl.textContent = "æ­¤ç€è¦½å™¨ä¸æ”¯æ´ GPS (Geolocation) åŠŸèƒ½ã€‚";
        return;
      }

      statusEl.textContent = "æ­£åœ¨å–å¾—ä½ç½®ï¼Œè«‹ç¨å€™â€¦";
      addLog("é–‹å§‹ GPS è¿½è¹¤ã€‚è«‹ç¢ºèªè£ç½®å·²é–‹å•Ÿå®šä½ï¼Œä¸¦å…è¨±æ¬Šé™ã€‚");

      // ä½¿ç”¨ watchPosition æŒçºŒè¿½è¹¤ä½ç½®
      watchId = navigator.geolocation.watchPosition(handleSuccess, handleError, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 1000
      });

      startBtn.disabled = true;
      stopBtn.disabled = false;
    });

    stopBtn.addEventListener("click", () => {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      statusEl.textContent = "å·²åœæ­¢ GPS è¿½è¹¤ã€‚";
      addLog("å·²åœæ­¢ GPS è¿½è¹¤ã€‚");
      startBtn.disabled = false;
      stopBtn.disabled = true;
    });
  </script>
</body>
</html>
